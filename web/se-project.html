<!DOCTYPE html>
<html>
  <head>
    
    <meta name="description" content="<p>采用 heritix+pagerank+lucene 方式搭建搜索引擎原型，并评估其性能。</p>
">
    
    <meta name="keywords" content="Linux Web 计算机 开发 编程">
    <meta name="author" content="harttle">      
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>搜索引擎搭建 - Harttle Land</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- style -->
    <!-- Bootstrap -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
    
    <!-- font-awesome -->
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
      
    <!-- Custom styles  -->
    <link href="/assets/css/sticky-footer-navbar.css" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">

    <!-- Icon -->
    <link rel="shortcut icon" href="/assets/img/favicon.png"> 

    
    
<style>
.headerbar{
  background: rgba(255, 255, 255, 0.75);
  box-shadow: inset 0 -1px 0 white, 0 1px 5px rgba(0,0,0,.3);
}
.headerbar .page-header{
  border-bottom: 0;
  margin-bottom: 0px;
  margin-top: 0px;
}
#page-content{
  margin-top: 20px;
  margin-bottom: 15px;
}
</style>


<link rel="stylesheet" href="/assets/css/markdown.css">
<style>
  /* By default it's not affixed in mobile views, so undo that */
  .sidebar.affix {
    position: static;
  }
  
  /* First level of nav */
  .sidenav {
    margin-top: 20px;
    margin-bottom: 20px; 
    padding-top:    10px;
    padding-bottom: 10px;
    text-shadow: 0 1px 0 #fff;
    background-color: #f5f5f5;
    border-radius: 5px;
  }
  
  /* All levels of nav */
  .sidebar .nav > li > a {
    display: block;
    color: #6c6c6c;
    padding: 5px 20px;
  }
  .sidebar .nav > li > a:hover,
  .sidebar .nav > li > a:focus {
    text-decoration: none;
    background-color: #e5e5e5;
    border-right: 1px solid #d5d5d5;
  }
  .sidebar .nav > .active > a,
  .sidebar .nav > .active:hover > a,
  .sidebar .nav > .active:focus > a {
    font-weight: bold;
    color: #555;
    background-color: transparent;
    border-right: 1px solid #000;
  }
  
  /* Nav: second level (shown on .active) */
  .sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    margin-bottom: 8px;
  }
  .sidebar .nav .nav > li > a {
    padding-top:    3px;
    padding-bottom: 3px;
    padding-left: 30px;
    font-size: 90%;
  }
  .sidebar .nav .nav .nav > li > a {
    padding-left: 40px;
  }
  .sidebar .nav .nav .nav .nav > li > a {
    padding-left: 50px;
  }
  .sidebar .nav .nav .nav .nav .nav > li > a {
    padding-left: 60px;
  }
  .sidebar .nav .nav .nav .nav .nav .nav> li > a {
    padding-left: 70px;
  }  
  
  /* Show and affix the side nav when space allows it */
  @media (min-width: 992px) {
    .sidebar .nav > .active > ul {
      display: block;
    }
    /* Widen the fixed sidebar */
    .sidebar.affix,
    .sidebar.affix-top,
    .sidebar.affix-bottom {
      width: 213px;
    }
    .sidebar.affix {
      position: fixed; /* Undo the static from mobile first approach */
      top: 90px;
    }
    .sidebar.affix-bottom {
      position: absolute; /* Undo the static from mobile first approach */
    }
    .sidebar.affix-bottom .sidenav,
    .sidebar.affix .sidenav {
      margin-top: 0;
      margin-bottom: 0;
    }
  }
  @media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .sidebar.affix-bottom,
    .sidebar.affix-top,
    .sidebar.affix {
      width: 263px;
    }
  } 
    
  .MathJax *{
    color: black!important;  
  }
</style>


    <!-- style -->
  </head>
  
  <body>
  
  <!-- content -->  
    <!-- Wrap all page content here -->
    <div id="wrap">

      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-inverse navbar-fixed-top global-nav">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Harttle Land</a>
          </div>
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
              <li id="blog"><a href="/category/blog.html">博客</a></li>
              <li id="album"><a href="/category/album.html">相册</a></li>
              <li id="about"><a href="/about.html">关于</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">链接 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="//harttle.duapp.com" target="_blank">God Notes</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">友情链接</li>
                  <li><a href="//www.pku.edu.cn/" target="_blank">北京大学</a></li>
                </ul>
              </li>
            </ul>
	    <ul class="nav navbar-nav pull-right">	 
	      <li>
		<a href="//github.com/harttle/harttle.github.io" target="_blank">
		  <i class="fa fa-github fa-lg"></i> GitHub
		</a>
	      </li>
	      <li>
		<a href="/feed.xml" target="_blank">
		  <i class="fa fa-rss-square fa-lg"></i> RSS
		</a>
	      </li>
	    </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>

      <!-- Begin page content -->
      <div id="main-content">
	
	
<div class="headerbar">
  <div class="page-header container">
    <h1>
      搜索引擎搭建 <small></small>
    </h1>
    <div>
      
      <span class="label label-info pull-left" style="margin-right: 10px;"><span class="glyphicon glyphicon-folder-open"></span> web</span>
      
      
      <span class="label label-success pull-left hidden-xs" style="margin-right: 10px;"><span class="glyphicon glyphicon-tag"></span> 爬虫</span>
      
      <span class="label label-success pull-left hidden-xs" style="margin-right: 10px;"><span class="glyphicon glyphicon-tag"></span> 搜索引擎</span>
      
      <a class="pull-right label label-warning" href="/category/blog.html" style="margin-left: 10px;">
          返回列表 <span class="glyphicon glyphicon-hand-left"></span>
      </a>
      <span class="pull-right label label-default hidden-xs">
          <span class="glyphicon glyphicon-time"></span> 2013年11月05日
      </span>
    </div>
  </div>
</div>

<div class="container">
 
  <div id="page-content">
    
    
<div class="row post-display">
    <div class="col-md-3 left" >
      <div class="sidebar"></div>
    </div>
    <div class="col-md-9 right md">
      <p>采用 heritix+pagerank+lucene 方式搭建搜索引擎原型，并评估其性能。</p>

<h1>爬虫（Heritrix）</h1>

<p>heritrix 是用作web归档的爬虫框架，java语言实现，具有 Apache License 自由软件许可。我们采用heritrix抓取网页数据。</p>

<p>可参照官方 Guide：<a href="https://webarchive.jira.com/wiki/display/Heritrix/Heritrix+3.0+and+3.1+User+Guide">https://webarchive.jira.com/wiki/display/Heritrix/Heritrix+3.0+and+3.1+User+Guide</a></p>

<h2>依赖项</h2>

<p>可选择 open-jdk 或者 oracle jre。</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="c"># open jdk</span>
sudo apt-get install open-jdk-7 <span class="c"># ubuntu</span>
sudo pacman -S open-jdk-7       <span class="c"># arch linux</span>
sudo rpm -ivh open-jdk-7        <span class="c"># centos</span>
</code></pre></div>
<p>oracle jre 安装可参考 <a href="http://www.liberiangeek.net/2012/04/install-oracle-java-runtime-jre-7-in-ubuntu-12-04-precise-pangolin/">http://www.liberiangeek.net/2012/04/install-oracle-java-runtime-jre-7-in-ubuntu-12-04-precise-pangolin/</a></p>

<h2>安装</h2>

<ol>
<li><p>下载并解压</p>

<p>在 <a href="https://webarchive.jira.com/wiki/display/Heritrix/Heritrix">https://webarchive.jira.com/wiki/display/Heritrix/Heritrix</a> 可以得到最新的版本。下载后解压。</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">tar -xzvf heritrix-xxx.tar.gz
</code></pre></div></li>
<li><p>设置环境变量</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="c"># 在 ~/.bashrc 中加入以下环境变量</span>
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/path/to/your/jre
<span class="nb">export </span><span class="nv">HERITRIX_HOME</span><span class="o">=</span>/path/to/your/heritrix
<span class="nb">export </span><span class="nv">JAVA_OPTS</span><span class="o">=</span>-Xmx1024M  <span class="c"># 可选，指定使用的内存上限</span>
</code></pre></div></li>
<li><p>启动 UI</p>

<p>参照：<a href="https://webarchive.jira.com/wiki/display/Heritrix/A+Quick+Guide+to+Running+Your+First+Crawl+Job">https://webarchive.jira.com/wiki/display/Heritrix/A+Quick+Guide+to+Running+Your+First+Crawl+Job</a></p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="nb">cd</span> <span class="nv">$HERITRIX_HOME</span>
<span class="c"># -a 设置用户名和密码，-j 设置抓取到的网页的路径，例如：</span>
bin/heritrix -a harttle:123456 -j /home/harttle/search-engine/pages/
</code></pre></div>
<p>然后在浏览器打开 https://localhost:8843，登录后根据提示新建一个job。</p></li>
</ol>

<h2>配置</h2>

<p>建立job后，可编辑 crawler-beans.cxml 文件进行设置。heritrix 支持在网页中直接编辑该文件。</p>

<blockquote>
<p>该文件位于 -j 参数指定的路径/job-name/ 下，或者默认位置：$HERITRIX_HOME/jobs/job-name/。</p>
</blockquote>

<ul>
<li><p>联系信息</p>

<p>设置 <code>metadata.operatorContactUrl</code> 为包含你的联系信息的页面，方便网络管理员联系你。</p>

<blockquote>
<p>该属性将被用于填充 HTTP 请求的 <code>User-Agent</code> 字段</p>
</blockquote></li>
<li><p>目标服务器</p>

<p>设置 <code>longerOverrides</code> 中的 <code>prop</code> 字段为要处理为web服务器域名</p></li>
<li><p>避免heritrix下载媒体文件</p>

<p><code>scope</code> 字段指定了heritrix的访问范围，为了避免访问媒体文件的 URI，可以编辑 <code>MatchesListRegexDecideRule</code> 字段，采用如下设置：</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">&lt;bean <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;org.archive.modules.deciderules.MatchesListRegexDecideRule&quot;</span>&gt;
  &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;decision&quot;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;REJECT&quot;</span>/&gt;
  &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;listLogicalOr&quot;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;true&quot;</span> /&gt;
  &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;regexList&quot;</span>&gt;
   &lt;list&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>avi|wmv|mpe?g|mp3<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>rar|zip|tar|gz<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>pdf|doc|xls|odt<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>xml<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>txt|conf|pdf<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>swf<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>js|css<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>bmp|gif|jpe?g|png|svg|tiff?<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
     &lt;value&gt;.*<span class="o">(</span>?i<span class="o">)(</span><span class="se">\.</span><span class="o">(</span>docx?|xlsx?|pptx?<span class="o">))</span><span class="nv">$&lt;</span>/value&gt;
   &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;
</code></pre></div></li>
<li><p>只归档 <code>Content-Type</code> 为 <code>text/html</code> 的文件</p>

<p><code>warcWriter</code> 字段指定了写入归档的规则，为了只匹配特定 <code>Content-Type</code> 的文件，可以为该字段添加如下规则：</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">&lt;bean <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;warcWriter&quot;</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;org.archive.modules.writer.WARCWriterProcessor&quot;</span>&gt;
   &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;shouldProcessRule&quot;</span>&gt;
     &lt;bean <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;org.archive.modules.deciderules.DecideRuleSequence&quot;</span>&gt;
       &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;rules&quot;</span>&gt;
         &lt;list&gt;
           &lt;!-- Begin by REJECTing all... --&gt;
           &lt;bean <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;org.archive.modules.deciderules.RejectDecideRule&quot;</span> /&gt;
           &lt;bean <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;org.archive.modules.deciderules.ContentTypeMatchesRegexDecideRule&quot;</span>&gt;
             &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;decision&quot;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;ACCEPT&quot;</span> /&gt;
             &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;regex&quot;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;^text/html.*&quot;</span> /&gt;
           &lt;/bean&gt;
         &lt;/list&gt;
       &lt;/property&gt;
     &lt;/bean&gt;
   &lt;/property&gt;
   &lt;!-- other properties --&gt;
&lt;/bean&gt;
</code></pre></div></li>
<li><p>启动 heritrix</p>

<p>在 Web-based UI 中，依次执行 build、launch、unpause 即可启动 heritix。</p></li>
</ul>

<h1>网站排名（Page-Rank）</h1>

<h2>提取链接关系</h2>

<p>我们现在要进行 Page-Rank，需要获得网页之间的链接关系。可以通过heritrix生成的日志文件（<code>crawl.log</code>）来提取。</p>

<p>参见：<a href="https://webarchive.jira.com/wiki/display/Heritrix/Logs">https://webarchive.jira.com/wiki/display/Heritrix/Logs</a></p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">cat crawl.log | awk <span class="s1">&#39;$7==&quot;text/html&quot;{print $6 &quot; =&gt; &quot; $4}&#39;</span> &gt; links
</code></pre></div>
<p>现在我们得到了包含链接关系的文件 <code>links</code>。</p>

<h2>进行 Page Rank</h2>

<p>Page Rank 是 Google 搜索引擎进行网站排名的重要算法之一。<a href="http://en.wikipedia.org/wiki/Pagerank">wiki</a> 给出了 Matlab 实现：</p>
<div class="highlight"><pre><code class="matlab language-matlab" data-lang="matlab"><span class="c">% Parameter M adjacency matrix where M_i,j represents the link from &#39;j&#39; to &#39;i&#39;, such that for all &#39;j&#39; sum(i, M_i,j) = 1</span>
<span class="c">% Parameter d damping factor</span>
<span class="c">% Parameter v_quadratic_error quadratic error for v</span>
<span class="c">% Return v, a vector of ranks such that v_i is the i-th rank from [0, 1]</span>

<span class="k">function</span><span class="w"> </span>[v] <span class="p">=</span><span class="w"> </span><span class="nf">rank</span><span class="p">(</span>M, d, v_quadratic_error<span class="p">)</span><span class="w"></span>

<span class="n">N</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c">% N is equal to half the size of M</span>
<span class="n">v</span> <span class="p">=</span> <span class="nb">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">v</span> <span class="p">=</span> <span class="n">v</span> <span class="o">./</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">last_v</span> <span class="p">=</span> <span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">inf</span><span class="p">;</span>
<span class="n">M_hat</span> <span class="p">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">.*</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">.*</span> <span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>

<span class="k">while</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">last_v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">v_quadratic_error</span><span class="p">)</span>
        <span class="n">last_v</span> <span class="p">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="n">v</span> <span class="p">=</span> <span class="n">M_hat</span> <span class="o">*</span> <span class="n">v</span><span class="p">;</span>
        <span class="n">v</span> <span class="p">=</span> <span class="n">v</span> <span class="o">./</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">end</span>

<span class="n">endfunction</span>

<span class="k">function</span><span class="w"> </span>[v] <span class="p">=</span><span class="w"> </span><span class="nf">rank2</span><span class="p">(</span>M, d, v_quadratic_error<span class="p">)</span><span class="w"></span>

<span class="n">N</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c">% N is equal to half the size of M</span>
<span class="n">v</span> <span class="p">=</span> <span class="nb">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">v</span> <span class="p">=</span> <span class="n">v</span> <span class="o">./</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   <span class="c">% This is now L1, not L2</span>
<span class="n">last_v</span> <span class="p">=</span> <span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">inf</span><span class="p">;</span>
<span class="n">M_hat</span> <span class="p">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">.*</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">.*</span> <span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>

<span class="k">while</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">last_v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">v_quadratic_error</span><span class="p">)</span>
        <span class="n">last_v</span> <span class="p">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="n">v</span> <span class="p">=</span> <span class="n">M_hat</span> <span class="o">*</span> <span class="n">v</span><span class="p">;</span>  
        <span class="c">% removed the L2 norm of the iterated PR</span>
<span class="k">end</span>

<span class="n">endfunction</span>
</code></pre></div>
<p>以下是调用过程代码：</p>
<div class="highlight"><pre><code class="matlab language-matlab" data-lang="matlab"><span class="n">M</span> <span class="p">=</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="p">;</span> <span class="mf">0.5</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="p">;</span> <span class="mf">0.5</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="p">;</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mf">0.5</span> <span class="mi">0</span> <span class="mi">0</span> <span class="p">;</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.5</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">];</span>
<span class="n">rank</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>Page Rank 的其他语言实现可以从 GitHub 获得：<a href="https://github.com/louridas/pagerank">https://github.com/louridas/pagerank</a></p>
</blockquote>

<h1>倒排索引（Lucene）</h1>

<p>倒排索引（Inverted index）被广泛应用在搜索引擎中，它存储着在全文搜索下某个单词在一个文档或者一组文档中的存储位置的映射。以下通过 Lucene 框架实现索引以及查询。</p>

<p>官方 Guide：<a href="http://lucene.apache.org/core/4_5_1/demo/overview-summary.html">http://lucene.apache.org/core/4_5_1/demo/overview-summary.html</a></p>

<h2>获取页面文件</h2>

<p>在使用 Lucene 进行全文索引之前，我们需要得到包含页面文件的目录。下面的 shell 脚本将完成 <code>.warc.gz</code> 到页面文件目录的转换。运行该脚本将产生 <code>files</code> 目录，其中包含所有的页面文件。</p>

<blockquote>
<p>页面文件将以编号命名，第一行为 URL，其后为 HTML 内容。</p>
</blockquote>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

less *.warc.gz | sed <span class="s1">&#39;s/\r//g&#39;</span> &gt; pages.txt

<span class="o">[</span> ! -d files <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir files

<span class="k">while </span><span class="nb">read</span> -r line
<span class="k">do</span>
<span class="k">    </span><span class="nb">let </span>i++
    lines<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span><span class="nv">$line</span>
<span class="k">done</span> &lt; pages.txt

<span class="nv">nline</span><span class="o">=</span><span class="nv">$i</span>

<span class="nv">url</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="nv">state</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
<span class="nv">ndoc</span><span class="o">=</span>0

<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1;i&lt;<span class="o">=</span>nline;i++ <span class="o">))</span>
<span class="k">do</span>
<span class="k">    </span><span class="nv">line</span><span class="o">=</span><span class="k">${</span><span class="nv">lines</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="k">}</span>

    <span class="k">case</span> <span class="s2">&quot;$line&quot;</span> in
        <span class="s2">&quot;WARC/1.0&quot;</span><span class="o">)</span>
            <span class="nv">state</span><span class="o">=</span><span class="s1">&#39;warc&#39;</span>
            ;;
        <span class="s2">&quot;WARC-Type: response&quot;</span><span class="o">)</span>
            <span class="nv">state</span><span class="o">=</span><span class="s1">&#39;warc-valid&#39;</span>
            <span class="nv">url</span><span class="o">=</span><span class="k">${</span><span class="nv">lines</span><span class="p">[</span><span class="nv">$i</span><span class="p">+1]</span><span class="k">}</span>
            <span class="nv">url</span><span class="o">=</span><span class="k">${</span><span class="nv">url</span><span class="p">#*: </span><span class="k">}</span>
            <span class="nb">let </span>ndoc++
            <span class="nb">echo</span> <span class="nv">$url</span> &gt;&gt; files/<span class="nv">$ndoc</span>
            <span class="nb">echo</span> &gt;&gt; files/<span class="nv">$ndoc</span>
            ;;
        <span class="s2">&quot;HTTP/1.1 200 OK&quot;</span><span class="o">)</span>
            <span class="o">[</span> <span class="nv">$state</span> <span class="o">=</span> <span class="s1">&#39;warc-valid&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">state</span><span class="o">=</span><span class="s1">&#39;http&#39;</span>
            ;;
        <span class="s2">&quot;&quot;</span><span class="o">)</span>
            <span class="o">[</span> <span class="nv">$state</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">state</span><span class="o">=</span><span class="s1">&#39;doc&#39;</span>
            ;;
        *<span class="o">)</span>
            <span class="o">[</span> <span class="nv">$state</span> <span class="o">=</span> <span class="s1">&#39;doc&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$line</span> &gt;&gt; files/<span class="nv">$ndoc</span>
            ;;
    <span class="k">esac</span>
<span class="k">done</span>
</code></pre></div>
<h2>建立索引</h2>

<ol>
<li><p>安装与配置</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="c"># 下载后解压</span>
tar -xzvf lucene-xxx.tar.gz
<span class="nb">cd </span>lucene

<span class="c"># 设置环境变量，直接加入所有的 jar 包</span>
<span class="nv">dir</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nb">export </span><span class="nv">CLASSPATH</span><span class="o">=</span><span class="sb">`</span>find -name <span class="s1">&#39;*.jar&#39;</span> | sed <span class="s2">&quot;s@^.@$dir@g&quot;</span> | sed <span class="s1">&#39;:a;N;s/\n/:/;ta&#39;</span><span class="sb">`</span> 
</code></pre></div></li>
<li><p>建立索引与搜索</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="c"># 建立索引，files 为页面文件所在目录，会在当前目录产生 index 目录来保存索引信息</span>
java org.apache.lucene.demo.IndexFiles -docs files

<span class="c"># 搜索，将进入交互式搜索程序</span>
java org.apache.lucene.demo.SearchFiles
</code></pre></div></li>
</ol>

    
      <style>
  /* JiaThis & Uyan bootstrap fix */
	.jiathis_style *, .jiathis_style,
  .jiathis_style_24x24 *, .jiathis_style_24x24{
      -webkit-box-sizing: content-box!important;
      -moz-box-sizing: content-box!important;
      box-sizing: content-box!important;
  }
  .jiathis_style_24x24{
          margin-top: 20px;
  }
</style>


<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_24x24 pull-right">
	<a class="jiathis_button_fb"></a>
	<a class="jiathis_button_linkedin"></a>
	<a class="jiathis_button_googleplus"></a>
	<!--a class="jiathis_button_tsina"></a-->
	<a class="jiathis_button_weixin"></a>
	<!--a href="http://www.jiathis.com/share?uid=1851884" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a-->
	<!--a class="jiathis_counter_style"></a-->
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1372495112151668" charset="utf-8"></script>
<!-- JiaThis Button END -->


<div class="clearfix"></div>
<hr/>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'harttleland'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
</div>


  </div>

</div>

      </div>
      
    </div>

    <div id="footer">
      <div class="container">
	<div class="credit nowrap">
	  <p class="text-muted" title="Copyright © 2013 Harttle. Hosted by GitHub and powered by Jekyll.">
	    Copyright © 2013 
	    <a href="//harttle.github.io">Harttle</a>. Hosted by
	    <a href="//github.com/" target="_blank">GitHub</a>
	    and powered by
	    <a href="//jekyllrb.com/">Jekyll</a>.
	    
	  </p>
	  <div class="pull-right hidden-xs follow">
	    <a href="https://www.facebook.com/harttle" target="_blank">
	      <i class="fa fa-facebook-square fa-lg"></i>
	    </a>
	    <a href="http://www.linkedin.com/profile/view?id=294339963" target="_blank">
	      <i class="fa fa-linkedin-square fa-lg"></i>
	    </a>
	    <a href="https://plus.google.com/113657098095399233141?rel=author" target="_blank">
	      <i class="fa fa-google-plus-square fa-lg"></i>
	    </a>
	  </div>	  
	</div>
      </div>
    </div>
<!-- content -->

<!-- script -->
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/libs/html5shiv/3.6.2/html5shiv.js"></script>
      <script src="//v3.bootcss.com/docs-assets/js/respond.min.js"></script>
    <![endif]-->
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="/assets/jquery/jquery.scrollUp.min.js"></script>
    <script src="/assets/jquery/jquery.lazyload.min.js" type="text/javascript"></script>
    
    <!-- Bootstrap -->
    <script src="/assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
    
    
    


<script>
  $(function(){    
    var toc = getTOC($('.post-display .right'));
    if (toc != null) {
      $('.sidebar').append(toc);
      
      //sidebar affix, this offset is for sidebar position recognition
      setTimeout(function () {
          var $sideBar = $('.sidebar')
          $sideBar.affix({
              offset: {                
                  top: function () {                    
                      var offsetTop      = $sideBar.offset().top;
                      var sideBarMargin  = parseInt($sideBar.children(0).css('margin-top'), 10);
                      sideBarMargin     += parseInt($('#page-content').css('margin-top'), 10);
                      return (this.top = offsetTop - navHeight - sideBarMargin);
                  },
                  bottom: function(){
                    var sideBarMargin  = parseInt($sideBar.children(0).css('margin-bottom'), 10);
                    return (this.bottom = footHeight + sideBarMargin);
                  }
              }
          });
      },100);
      
      //sidebar scroll spy
      $('body').scrollspy({
        target: '.sidebar',
        offset: navHeight + 10  //make sure to spy the element when scrolled to
      }); 
    }
    else{
      $('.post-display .right').removeClass('col-md-9');
      $('.post-display').removeClass('row-fluid');
      $('.post-display .left').remove();
    }
  });
  
  //生成目录
  function getTOC($content) {    
    var $toc = $('<ul class="nav level-0" >').addClass("nav sidenav");

    var base_level = 1;
    while ($content.find('h' + base_level).length < 1 && base_level < 7) base_level += 1;
    if (base_level == 7) return null;
    
    $content.find(':header').each(function (i) {
      var $this = $(this);
      $this.attr('id', i);
      
      var level = parseInt(this.nodeName.substr(1));
      var offset = level - base_level;
      
      var li = new $('<li/>')
          .append('<a href="#' + i + '" class="animate">' + $this.text() + '</a>')
          .append($('<ul class="nav level-'+(offset+1)+'"/>'));
      
      $('<div>').append($toc).find('ul.level-'+offset+':last').append(li);
    });
    return $toc;
  }
</script>

<!-- latex render begin -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
  MathJax.Hub.Queue(function () {
    $('body').scrollspy('refresh');
  });
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG"></script>
<!-- html config: TeX-MML-AM_HTMLorMML -->
<!-- latex render end -->


    
    <script>
      var navHeight = 50;
      var footHeight = $('#footer').outerHeight(true);
      $(function(){
	
        //更新菜单
        $('.nav #blog').attr('class','active');
        
        //激活工具提示
        $('[data-toggle="tooltip"]').tooltip();
        
        //图片延迟加载
        $("img.lazy").lazyload({effect : "fadeIn", skip_invisible : false});	//bootstrap thumbnail img will be invisible at the begining
        
        //回到顶部按钮
        $.scrollUp({
	  scrollName: 'scrollUp',topDistance: '300',topSpeed: 300,animation: 'fade',animationInSpeed: 500,
	  animationOutSpeed: 500,scrollText: '',activeOverlay: false,
	});	
        
        //页面内链接滑动效果
        $body = (window.opera) ? (document.compatMode == "CSS1Compat" ? $('html') : $('body')) : $('html,body');
        $('a.animate').click(function(){
          var offset = navHeight;
          if ($(this).attr('offset')) {
            offset += parseInt($(this).attr('offset')); 
          }
          $body.animate({scrollTop: $($(this).attr('href')).offset().top - offset}, 500);
          return false;
        });        
      });
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-45491170-1', 'harttle.github.io');
      ga('send', 'pageview');
    </script>
<!-- script -->

  </body>
</html>
