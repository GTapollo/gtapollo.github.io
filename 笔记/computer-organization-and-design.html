<!DOCTYPE html>
<html>
  <head>
    
    <meta name="description" content=""Computer Organization and Design", David A. Patterson, John L. Hennessy, 机械工业出版社">
    
    <meta name="keywords" content="Linux Web 计算机 开发 编程">
    <meta name="author" content="harttle">      
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Computer Organization and Design - Harttle Land</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- style -->
    <!-- Bootstrap -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
    
    <!-- font-awesome -->
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
      
    <!-- Custom styles  -->
    <link href="/assets/css/sticky-footer-navbar.css" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">

    <!-- Icon -->
    <link rel="shortcut icon" href="/assets/img/favicon.png"> 

    
    
<style>
.headerbar{
  background: rgba(255, 255, 255, 0.75);
  box-shadow: inset 0 -1px 0 white, 0 1px 5px rgba(0,0,0,.3);
}
.headerbar .page-header{
  border-bottom: 0;
  margin-bottom: 0px;
  margin-top: 0px;
}
#page-content{
  margin-top: 20px;
  margin-bottom: 15px;
}
</style>


<link rel="stylesheet" href="/assets/css/markdown.css">
<style>
  /* By default it's not affixed in mobile views, so undo that */
  .sidebar.affix {
    position: static;
  }
  
  /* First level of nav */
  .sidenav {
    margin-top: 20px;
    margin-bottom: 20px; 
    padding-top:    10px;
    padding-bottom: 10px;
    text-shadow: 0 1px 0 #fff;
    background-color: #f5f5f5;
    border-radius: 5px;
  }
  
  /* All levels of nav */
  .sidebar .nav > li > a {
    display: block;
    color: #6c6c6c;
    padding: 5px 20px;
  }
  .sidebar .nav > li > a:hover,
  .sidebar .nav > li > a:focus {
    text-decoration: none;
    background-color: #e5e5e5;
    border-right: 1px solid #d5d5d5;
  }
  .sidebar .nav > .active > a,
  .sidebar .nav > .active:hover > a,
  .sidebar .nav > .active:focus > a {
    font-weight: bold;
    color: #555;
    background-color: transparent;
    border-right: 1px solid #000;
  }
  
  /* Nav: second level (shown on .active) */
  .sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    margin-bottom: 8px;
  }
  .sidebar .nav .nav > li > a {
    padding-top:    3px;
    padding-bottom: 3px;
    padding-left: 30px;
    font-size: 90%;
  }
  .sidebar .nav .nav .nav > li > a {
    padding-left: 40px;
  }
  .sidebar .nav .nav .nav .nav > li > a {
    padding-left: 50px;
  }
  .sidebar .nav .nav .nav .nav .nav > li > a {
    padding-left: 60px;
  }
  .sidebar .nav .nav .nav .nav .nav .nav> li > a {
    padding-left: 70px;
  }  
  
  /* Show and affix the side nav when space allows it */
  @media (min-width: 992px) {
    .sidebar .nav > .active > ul {
      display: block;
    }
    /* Widen the fixed sidebar */
    .sidebar.affix,
    .sidebar.affix-top,
    .sidebar.affix-bottom {
      width: 213px;
    }
    .sidebar.affix {
      position: fixed; /* Undo the static from mobile first approach */
      top: 90px;
    }
    .sidebar.affix-bottom {
      position: absolute; /* Undo the static from mobile first approach */
    }
    .sidebar.affix-bottom .sidenav,
    .sidebar.affix .sidenav {
      margin-top: 0;
      margin-bottom: 0;
    }
  }
  @media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .sidebar.affix-bottom,
    .sidebar.affix-top,
    .sidebar.affix {
      width: 263px;
    }
  } 
    
  .MathJax *{
    color: black!important;  
  }
</style>


    <!-- style -->
  </head>
  
  <body>
  
  <!-- content -->  
    <!-- Wrap all page content here -->
    <div id="wrap">

      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-inverse navbar-fixed-top global-nav">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Harttle Land</a>
          </div>
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
              <li id="blog"><a href="/category/blog.html">博客</a></li>
              <li id="album"><a href="/category/album.html">相册</a></li>
              <li id="about"><a href="/about.html">关于</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">链接 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="//harttle.duapp.com" target="_blank">God Notes</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">友情链接</li>
                  <li><a href="//www.pku.edu.cn/" target="_blank">北京大学</a></li>
                </ul>
              </li>
            </ul>
	    <ul class="nav navbar-nav pull-right">	 
	      <li>
		<a href="//github.com/harttle/harttle.github.io" target="_blank">
		  <i class="fa fa-github fa-lg"></i> GitHub
		</a>
	      </li>
	      <li>
		<a href="/feed.xml" target="_blank">
		  <i class="fa fa-rss-square fa-lg"></i> RSS
		</a>
	      </li>
	    </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>

      <!-- Begin page content -->
      <div id="main-content">
	
	
<div class="headerbar">
  <div class="page-header container">
    <h1>
      Computer Organization and Design <small>The Hardware/Software Interface</small>
    </h1>
    <div>
      
      <span class="label label-info pull-left" style="margin-right: 10px;"><span class="glyphicon glyphicon-folder-open"></span> 笔记</span>
      
      
      <span class="label label-success pull-left hidden-xs" style="margin-right: 10px;"><span class="glyphicon glyphicon-tag"></span> 读书笔记</span>
      
      <span class="label label-success pull-left hidden-xs" style="margin-right: 10px;"><span class="glyphicon glyphicon-tag"></span> 体系结构</span>
      
      <a class="pull-right label label-warning" href="/category/blog.html" style="margin-left: 10px;">
          返回列表 <span class="glyphicon glyphicon-hand-left"></span>
      </a>
      <span class="pull-right label label-default hidden-xs">
          <span class="glyphicon glyphicon-time"></span> 2013年11月23日
      </span>
    </div>
  </div>
</div>

<div class="container">
 
  <div id="page-content">
    
    
<div class="row post-display">
    <div class="col-md-3 left" >
      <div class="sidebar"></div>
    </div>
    <div class="col-md-9 right md">
      <h1>Abstractions</h1>

<h2>Concepts</h2>

<p><strong>Moore&#39;s law</strong></p>

<blockquote>
<p>Over the history of computing hardware, the number of transistors on integrated circuits doubles approximately every two years.</p>
</blockquote>

<p><strong>Compiler</strong></p>

<blockquote>
<p>A program that translates high-level language statements into assembly language statements.</p>
</blockquote>

<p><strong>Assembler</strong></p>

<blockquote>
<p>A program that translates a symbolic version of instructions into the binary version.</p>
</blockquote>

<p><strong>High-level programming langrage</strong></p>

<blockquote>
<p>A portable language that is composed of words and algebraic notation that can be translated by a compiler into assembly language.</p>
</blockquote>

<p><strong>Assembly language</strong></p>

<blockquote>
<p>Asymbolic representation of machine instructions.</p>
</blockquote>

<p><strong>Machine language</strong></p>

<blockquote>
<p>A binary representation of machine instructions.</p>
</blockquote>

<p><strong>5 components of a computer</strong></p>

<ul>
<li>Input</li>
<li>Output</li>
<li>Memory</li>
<li>Datapath</li>
<li>Control</li>
</ul>

<blockquote>
<p>The last two sometimes combined and called the processor.</p>
</blockquote>

<p><strong>Instruction set architecture</strong></p>

<blockquote>
<p>One key interface between the levels of abstraction is the instruction set architecture-the interface between the hardware and low-level software.</p>
</blockquote>

<h2>Performance</h2>

<h3>Measurement and Limitation</h3>

<p>$$
\begin{eqnarray}
CPU~time &amp;=&amp; Instruction~count \times CPI \times Clock~cycle~time\\
        &amp;=&amp; \frac{Instruction~count \times CPI}{Clock~rate}
\end{eqnarray}
$$</p>

<p>$$
Power = Capacitive~load \times Voltage^2 \times Frequency~switched
$$</p>

<h3>Fallacies and Pitfalls</h3>

<blockquote>
<p><strong>Pitfall</strong>: Expecting the improvement of one aspect of a computer to increse overall performance by an amount proportional to the size of the improvement.</p>
</blockquote>

<p><strong>Amdahl&#39;s law</strong></p>

<p>$$
Execution~time~after~improvement = \\
\frac{Execution~time~affected~by~improvement}{Amount~of~improvement} + Execution~time~unaffected
$$</p>

<blockquote>
<p><strong>Pitfall</strong>: Using a subset of the performance equation as a performance metric.</p>
</blockquote>

<p>For example:</p>

<p>$$
\begin{eqnarray}
MIPS &amp;=&amp; \frac{Instruction~count}{Execution~time \times 10^6} \\
    &amp;=&amp; \frac{Clock~rate}{CPI \times 10^6}
\end{eqnarray}
$$</p>

<blockquote>
<p>Instruction per program is not considered.</p>
</blockquote>

<p>Execution time is the only valid and unimpeachable measure of performance.</p>

<h1>Instructions</h1>

<blockquote>
<p>Common goal of computer designers: to find a language that makes it easy to build the hardware and the compiler while maximizing performance and minimizing cost and power.</p>
</blockquote>

<p><strong>Stored-program concept</strong> </p>

<p>The idea that instructions and data of many types can be stored in memory as numbers, leading to the stored-program computer.</p>

<h2>Design Principle</h2>

<p>Each category of MIPS instructions is associates with constructs that appear in programming language:</p>

<ul>
<li>The arithmetic: assignment statements.</li>
<li>Data transfer: dealing with data structures like arrays or structures.</li>
<li>Conditional branches: <em>if</em> statement.</li>
<li>Unconditional jumps: procedure call and returns and <em>for</em>, <em>case/switch</em> statements.</li>
</ul>

<ol>
<li><p>Simplicity favors regularity</p>

<p>Requiring every instruction to have exactly three operands, no more and no less, conforms to the philosophy of keeping the hardware simple.</p></li>
<li><p>Smaller is faster</p>

<p>Number of registers is limited in 32. A large number of registerss may increse the clock cycle time simply because it takes electronic signals longer when they must travel farther.</p>

<p><strong>Big-endian and Small-endian</strong></p>

<p>Big-endian: computers use the address of the leftmost byte ( or &quot;big end&quot; ) as the word address.
Small-endian: otherwise.</p>

<blockquote>
<p>MIPS is in the big-endian camp.</p>
</blockquote></li>
<li><p>Make the common case fast</p>

<p>Avoid the load instruction when arithmetic instruction&#39;s one operand is a constant.</p>

<p>Example:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">addi    $s3,    $s3,    4

# instead of
lw      $t0,    AddrConst4($s1)
add     $s3,    $s3,    $t0
</code></pre></div>
<p><strong>One&#39;s complement</strong></p>

<p>A notation that represents the most negative value by 10...000 and the most positive value by 01...11, leaving an equal number of negatives and positives but ending up with two 0s. </p>

<blockquote>
<p>The term is also used to mean the inversion of every bit.</p>
</blockquote>

<p><strong>two&#39;s complement</strong></p>

<p>$-x = \bar{x}+1$, leading 0s mean positive, and leading 1s mean negative.</p>

<blockquote>
<p>Two&#39;s complement gets its name from the rule that the unsigned sum of an n-bit number and its negative is $2^n$.</p>
</blockquote></li>
<li><p>Good design demands good compromises</p>

<p>The compromise chosen by the MIPS designers is to keep <strong>all instructions the same length</strong> , thereby requiring different kinds of instruction formats for different kinds of instructions.</p>

<ul>
<li>R-type: op-6bits, rs-5bits, rt-5bits, rd-5bits, shamt-5bits, funct-6bits.</li>
<li>I-type: op-6bits, rs-5bits, rt-5bits, const or addr-16bits</li>
<li>J-type: op-6bits, addr-26bits</li>
</ul>

<p><strong>The simplicity of the &quot;equipment&quot;</strong> : MIPS doesn&#39;t include branch on less than (<code>blt</code> is a pseudo-instruction) because it&#39;s too complicated; either it would stretch the clock cycle time or it would take extra clock cycles per instruction. Two faster instructions (<code>slt</code> and <code>beq</code>) are more usefull.</p></li>
</ol>

<h2>Register usage</h2>

<p><strong>Spilling registers</strong></p>

<blockquote>
<p>The process of putting less commonly used variables (or those needed later) into memory.</p>
</blockquote>

<p><strong>Dada-transfer instruction</strong></p>

<p>A command that moves data between memory and registers.</p>

<p><strong>Sign extension</strong></p>

<p>Copy the sign repeatedly to fill the rest of the bits in the left.</p>

<p><strong>Alignment restriction</strong></p>

<p>MIPS tries to keep the stack aligned to word addresses, allowing the program to always use <code>lw</code> and <code>sw</code> to access the stack.</p>

<blockquote>
<p>C string variable or an array of bytes will pack 4 bytes per word, and a Java variable or array of shorts packs 2 halfwords per word.</p>
</blockquote>

<h3>Stack spilling</h3>

<p><code>$sp</code> is a stack pointer, which is adjusted by one word for each register that is saved or restored.</p>

<h3>Procedure call</h3>

<ul>
<li><p>preserved by caller  </p>

<p><code>$t0-$t9</code>: ten temporary registers, <code>$a0-$a3</code>: four argument registers, <code>$v0-v1</code>: two return registers</p>

<blockquote>
<p>Not preserved by the calee on a procedure call. The caller will push them.</p>
</blockquote></li>
<li><p>preserved by callee  </p>

<p><code>$s0-$s7</code>: eight saved registers, <code>$ra</code>: return address, <code>$sp</code>: the stack pointer and stack above <code>$sp</code></p>

<blockquote>
<p>Must be preserved on a procedure call. If used, the callee saves and restores them.  </p>
</blockquote></li>
</ul>

<blockquote>
<p>Iteration can significantly improve performance by removing the overhead associated with procedure calls.</p>
</blockquote>

<h3>Data allocate</h3>

<p><img src="/assets/img/blog/mips-mem.gif" alt="mips-mem"></p>

<p><code>$gp</code>: the global pointer that is reserved to point to the static area.  </p>

<p><code>$fp</code>: A value denoting the location of the saved registers and local variables for a given procedure.</p>

<p>The frame point is convenient because all references to variables in the stack within a procedure will have the same offset.</p>

<blockquote>
<p>more than 4 paras: the trailing params are stored at <code>$fp+1</code>, <code>$fp+2</code>, etc.
Pointers vs Arrays: we calculate address (index multiply 4) in array addressing, while add 4 directly in pointer addressing.</p>
</blockquote>

<h3>Reserved registers</h3>

<p><code>$zero</code> always equals 0.
<code>$at</code> is reserved by the assembler to handle large constants in immediate instructions and addresses in load/store instructions.
<code>$k0, $k1</code> reserved for the operating system to handle exception procedure. They&#39;re used to retain the address of instruction that causes the exception (which can be get from EPC register), when exception procedure exits and restores all registers before the exception. Thus the program can jump back to the normal procedure.</p>

<h2>Addressing Mode</h2>

<p><strong>Basic block</strong></p>

<p>Basic block is a sequence of instructions without branches, except possibly at the end , and without branch targets or branch labels, except possibly at the begining.</p>

<blockquote>
<p>One of the first early phases of compilation is breaking the program into basic blocks.</p>
</blockquote>

<h3>Branch instruction</h3>

<p>Branch instructions use 16-bit field address, which means no program will larger than 2^16.</p>

<p>While the destination of branch instructions is likely to be close to the branch. If we use <strong>PC-relative addressing</strong> , the sum will allow the program to be as large as 2^32.</p>

<blockquote>
<p>While the <code>L1</code> in <code>beq    $s0,    $s1,    L1</code> could be bigger than 2^16, MIPS will break it into 2 instructions like:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">    bne     $s0,    $s1,    L2
    j       L1
L2:
</code></pre></div></blockquote>

<h3>Jump instruction</h3>

<p>Jump instructions use 26-bit field adress, MIPS stretch the distance by having it refer to the number of <em>words</em> to the next instruction instead of number of <em>bytes</em></p>

<blockquote>
<p>The loader and linker must be careful to avoid placing a program across an address boundary of 256MB, which is 2^28 bit. </p>
</blockquote>

<h3>Summary</h3>

<ul>
<li>Register addresing: <code>jr   $ra</code></li>
<li>PC-relative addressing: <code>bne  $s0,    $s1,    Label</code></li>
<li>Pseudodirect addressing: <code>j   Label</code></li>
</ul>

<h2>Parallelism and Synchronization</h2>

<p><strong>Data Race</strong></p>

<p>Two memory accesses form a data race if they are from different threads to ssame location, at least one is a write, and they occur one after another.</p>

<p>One typical operation for building synchronization operations is the <em>atomic exchange</em> or <em>atomic swap</em>, while the challenge lies in that it requires both a memory read and a write in a single, uninterruptible instruction.</p>

<p>MIPS contains a pair of instructions called a <em>load linked</em> and <em>store conditional</em>. These are used in sequence: if the content of the memory specified by <em>load linked</em> is changed before the <em>store conditional</em>, then the store fails.</p>

<blockquote>
<p>Although it was presented for multi-processor sync, atomic exchange is also useful for the OS in dealing with multiple processes in a single processor. To ensure nothing interferes in a single processor, the <em>store conditional</em> also fails if the processor does a context switch between the two instructions.</p>

<p>Store conditional will fail after either another attempted store or any exception, in particular, only register-register instructions can safely be permited between the two instructions; otherwise, it is possible to create deadlock situations.</p>
</blockquote>

<h2>Translating &amp; Starting</h2>

<h3>Compiler</h3>

<p>The compiler transforms the C program to <em>assembly language program</em>, a symbolic form of what the machine understands.</p>

<p><strong>Assembly Language</strong></p>

<p>A symbolic language that can be translated into binary machine language.</p>

<h3>Assembler</h3>

<p>Assembler translate the <em>assembly language program</em> into machine language program, called object file.</p>

<blockquote>
<p>Pseudoinstructions give MIPS a richer set of assembly language instructions than those implemented by the hardware. The only cost is reserving one register, <code>$at</code>.</p>
</blockquote>

<h3>Linker</h3>

<p><strong>Linker</strong>, also called <em>link editor</em>, is a systems program that combines independenty assembled machine language programs and resolves all undefined labels into an executable file. There are 3 steps for the linker:</p>

<ol>
<li>Place code and data modules symbolically in memory.</li>
<li>Determine the addresses of data and instrucion labels.</li>
<li>Patch both the internal and external references.</li>
</ol>

<blockquote>
<p>Linker allows compiling and assembling each procedure independently, particulaly library routines, avoiding processing the whole program every time a small routine changes.
Typically, the <em>executable file</em> has the same format as an object file, except that it contains no unresolved references.</p>
</blockquote>

<h3>Loader</h3>

<p>A systems program that places an object program in main memory so that it is ready to execute.</p>

<h3>Dynamically linked libraries</h3>

<p>The static libraries has a few cons:</p>

<ul>
<li>The library routines become part of the exe file. The program need re-compiled when library updated.</li>
<li>It loads all libs that are called anywhere in the exe, even not called.</li>
</ul>

<p>Lazy procedure linkage of DLLs:</p>

<p>The first time the lib is called, the program calls the dummy entry and follows the indirect jump. It points to code that puts a number in a register to identify the desired lib and jumps to the dynamic linker/loader. The linker/loader finds the lib, remap it, and chages the address in the indirect jump location to the lib.</p>

<h3>Starging a Java Program</h3>

<p>Rather than compile to the assemly language of a target computer, Java is compiled first to the instructions that are easy tointerpret: the <em>Java bytecode</em> instruction set. A interpreter called <em>Java Virtual Machine</em> can execute Java bytecodes.</p>

<p>Pro: portability; Con: lower performance. <em>Just In Time compilers (JIT)</em> typically find the &quot;hot&quot; methods and compile them into native instruction set, and is saved for next run.</p>

<blockquote>
<p>Typically, the unoptimized C program is faster than the interpreted Java code. Using the JIT compiler makes Java faster than the unoptimized C and slightly slower than highest optimized C code.</p>
</blockquote>

<h2>Fallacies and Pitfalls</h2>

<blockquote>
<p>Fallacy: More powerful instructions mean higher performance.</p>
</blockquote>

<p>Complex instructions consume more time.</p>

<blockquote>
<p>Fallacy: Write in assembly language to obtain the highest performance.</p>
</blockquote>

<p>This battle between compilers and assembly language coders is one situation in which humans are losing ground. Today&#39;s C compilers generally ignore register hints made by programmers.</p>

<blockquote>
<p>Fallacy: The importance of commercial binary compatibility means successful instruction set don&#39;t change.</p>
</blockquote>

<p>While backwards binary compatibility is sacrosanct, the x86 architecture has grown dramatically.</p>

<blockquote>
<p>Fallacy: Forgetting that sequential word addresses in machines with byte addressing do not differ by one.</p>
</blockquote>

<p>The address of next word can be found by incrementing the address in a register by the size of word, not one.</p>

<blockquote>
<p>Pitfall: Using a pointer to an automatic variable outside its defining procedure.</p>
</blockquote>

<p>The memory that contains the an array that is local to that procedure will be reused as soon as the procedure returns.</p>

<h1>Arithmetic for Computers</h1>

<h2>Addition and Subtraction</h2>

<ol>
<li><p>Add (<code>add</code>), and immediate (<code>addi</code>), and subtract (<code>sub</code>) cause exceptions on overflow.
MIPS detects overflow with an <em>exception</em> (or <em>interrupt</em> ),  which is an unscheduled procedure call. The address of current instruction is saved and the computer jumps to predefined address to invoke the appropriate routine for that exception.</p>

<blockquote>
<p>MIPS uses <em>exception program counter</em> (EPC) to contain the address of the instruction that causes the exception. The instruction <em>move from system control</em> (<code>mfc0</code>) is used to copy EPC into a general-purpose register.</p>
</blockquote></li>
<li><p>Add unsigned (<code>addu</code>), add immediate unsigned (<code>addiu</code>), and subtract unsigned (<code>subu</code>) do not cause exceptions on overflow.
Programmers can trap overflow anyway: when overflow occurs, the sign bit of the result is not properly set. Compairing with sign bits of operands, the sign bit of the result can be determined. </p></li>
</ol>

<blockquote>
<p>SIMD (single instruction, multiple data): By partitioning the carry chains within a 64-bit adder, a processor could perform simultaneous operations on a short vecters of eight 8-bit operands, four 16-bit operands, etc. Vectors and 8-bit data often appears in multimedia routine.</p>
</blockquote>

<h2>Multiplication</h2>

<p>multiplicand * multiplier = product</p>

<h3>Sequential Version of the Multiplication</h3>

<p><img src="/assets/img/blog/multi1.png" alt="sequential-multiply"></p>

<p><img src="/assets/img/blog/multi-illu.png" alt="sequential-multiply-illu"></p>

<p>Refined version:</p>

<ul>
<li>Init: put multiplier to the left 32-bit of the product register.</li>
<li>Cycle: 

<ol>
<li>if the last bit of product register is 1, add the left 32-bit with the multiplicand</li>
<li>shift right the product register</li>
</ol></li>
<li>Final: the product register contains the 64-bit product</li>
</ul>

<p><img src="/assets/img/blog/multi2.png" alt="refined"></p>

<h3>Faster Multiplication</h3>

<p>A way to organize these 32 addtions is in a parallel tree:</p>

<p><img src="/assets/img/blog/multi3.png" alt="parallel"></p>

<h3>Multiply in MIPS</h3>

<p>The registers <code>Hi</code> and <code>Lo</code> contains the 64-bit product. Call <code>mflo</code> to fetch the 32-bit product, <code>mfhi</code> can be used to get <code>Hi</code> to test for overflow.</p>

<h2>Division</h2>

<p>Dividend = Quotient * Divisor + Remainder</p>

<h3>Division Algorithm</h3>

<p><img src="/assets/img/blog/divide1.png" alt="divide"></p>

<p><img src="/assets/img/blog/divide-illu.png" alt="divide-illu"></p>

<p>Improved version:</p>

<ul>
<li>Init: put the dividend in the right 32-bit of remainder register.</li>
<li>Cycle: 

<ol>
<li>subtract the left 32-bit of remainder by the divisor</li>
<li>shift left the remaider register</li>
<li>set the last bit as new quotient bit</li>
</ol></li>
<li>Final: the left 32-bit contains the remainder, right 32-bit contains the quotient.</li>
</ul>

<p><img src="/assets/img/blog/divide2.png" alt="divede-improved"></p>

<h3>Faster Division</h3>

<p><strong>SRT division</strong>: try to guess several quotient bits per step, using a table lookup based on the upper bits of the dividend and remainder. The key is guessing the value to subtract.</p>

<h3>Divide in MIPS</h3>

<p><code>Hi</code> contains the remainder, and <code>Lo</code> contains the quotient after the divide instruction complete.</p>

<blockquote>
<p>MIPS divide instructions ignore overflow. MIPS software must check the divisor to discover division by 0 as well as overflow.</p>
</blockquote>

<h2>Floating Point</h2>

<p><strong>scientific notation</strong> A notation that renders numbers with a single digit to the left of the decimal point.</p>

<p><strong>normalized</strong> A number in floating-point notation that has no leading 0s.</p>

<p><strong>fraction</strong> The value, generally between 0 and 1, placed in the fraction field.</p>

<p><strong>exponent</strong> In the numerical representation system of floating-point arithmetic, the value that is placed in the exponent field.</p>

<p><em>overflow</em> the exponent is too large to be represented in the exponent field.</p>

<p><strong>floating point</strong> Computer arithmetic that represents numbers in which the binary point is not fixed.</p>

<p>In general, floating-point numbers are of the form: $(-1)^S \times F \times 2^E$</p>

<p>MIPS float: sign(1 bit) + exponent(8 bit) + fraction(23 bit)
MIPS double: s(1 bit) + exponent(11 bit) + fraction(52 bit)</p>

<p>IEEE 754 uses a bias of 127 for single precesion, and makes the leading 1 implicit. Since 0 has no leading 1, it&#39;s given the reserved exponent 0 so that hardware won&#39;t attach a leading 1.</p>

<p>Thus 00...00 represents 0; the representation of the rest are in the following form:</p>

<p>$(-1)^S \times (1 + Fraction)\times 2^(Exponent - Bias)$</p>

<blockquote>
<p>The exponent is located left and the bias is for comparison convenience.</p>
</blockquote>

<h1>The Processor</h1>

<h2>Introduction</h2>

<p>A abstract view of the implementation of the MIPS subset showing the major functional units and the major connections between them:</p>

<p><img src="/assets/img/blog/mips-abs.png" alt="abstract-view"></p>

<p>The basic implementation of the MIPS subset, including the necessary multiplexors and control lines:</p>

<p><img src="/assets/img/blog/mips-basic.png" alt="mips-basic"></p>

<p><strong>asserted</strong></p>

<p>The signal is logically high or true.</p>

<p><strong>deasserted</strong></p>

<p>The signal is logically low or false.</p>

<p><strong>Clocking methodology</strong></p>

<p>The approach used to determine when data is valid and stable relative to the clock.</p>

<p><strong>Edge-triggered clocking</strong></p>

<p>A clocking scheme in which all state changes occur on a clock edge.</p>

<p><strong>control signal</strong></p>

<p>A signal used for multiplexor selection or for directing the operation of a functional unit; contrasts with a <strong>data signal</strong> , which contains information that is operated on by a funcional unit. </p>

<blockquote>
<p>The state element is changed only when the write control signal is asserted and a clock edge occurs.</p>
</blockquote>

<h2>A Simple Implementation Scheme</h2>

<p><strong>ALUOp</strong> indicates whether the operation to be performed should be add for loas and stores, substract for beq, or determined by the operation encoded in the funct field.</p>

<p><strong>Multiple levels of decoding</strong></p>

<p>The main control unit generates the ALUOp bits, which then are used as input to the ALU control that generates the actual signals to control the ALU unit.</p>

<p>The datapath with all necessary multiplexors and all control lines identified:</p>

<p><img src="/assets/img/blog/mips-all.png" alt="mips-all"></p>

<p><strong>Single-cycle implementation</strong></p>

<p>Also called single clock cycle implementation. An implementation in which an instruction is executed in one clock cycle.</p>

<blockquote>
<p>The clock cycle is determined by the longest possible path in the processor.</p>
</blockquote>

<h2>An Overview of Pipelining</h2>

<p>Assuming ideal conditions:</p>

<p>Time between instructions(pipelined) = Time between instructions(nonpipelined) / Number of pipe states</p>

<blockquote>
<p>Pipelining improves performance by increasing instruction throughput, as opposed to decreasing the execution time of an individual instruction, also called latency.</p>
</blockquote>

<p><strong>Structual Hazards</strong></p>

<p>When a planned instruction cannot execute in the proper clock cycle because the hardware does not support the combination of instructions that are set to execute.</p>

<p><strong>Data Hazards</strong></p>

<p>Data Hazards occure when the pipeline must be stalled because one step must wait for another to complete.</p>

<p><strong>Control Hazards</strong></p>

<p>Arising from the need to make a decision based on the results of one instruction while others are executing.</p>

<h2>Pipelined Datapath and Control</h2>

<p>The datapath is separated into 5 pieces:</p>

<ol>
<li>IF: Instruction fetch</li>
<li>ID: Instruction decode and register file read</li>
<li>EX: Execution or address calculation</li>
<li>MEM: Data memory access</li>
<li>WB: Write back</li>
</ol>

<p>We can divede the control lines into 5 groups according to the pipeline state</p>

<ol>
<li>IF: Signals to read instruction memory and write PC are always asserted, nothing to control.</li>
<li>ID: As in the previous state, the same thing happens at every clock cycle, no optional control lines to set.</li>
<li>EX: The signals to be set are RegDst, ALUOp, and ALUSrc. The signals select the Result register, the ALU operation, and either Read data 2 or a sign-extended immediate for the ALU.</li>
<li>MEM: The control lines set are: Branch, MemRead, and MemWrite. These signals are set by the branch equal, load, and store instructions.</li>
<li>WB: MemtoReg, which decides between sending the ALU result or the memory value to the register file; Reg Write, which writes the chosen value.</li>
</ol>

<p><strong>Multiple-clock-cycle pipeline diagram</strong> gives overviews of pipelining situations:</p>

<p><img src="/assets/img/blog/multiple-clock-cycle-pipeline.png" alt="multiple-clock-cycle-pipeline"></p>

<p><strong>Single-clock-cycle diagram</strong> represents a vertical slice through a set of multiple-clock-cycle diagrams, showing the usage of the datapath by each of the instructions in the pipeline at the designated clock cycle.</p>

<p><img src="/assets/img/blog/single-clock-cycle-pipeline.png" alt="single-clock-cycle-pipeline"></p>

<h2>Data Hazards</h2>

<h3>Forwarding</h3>

<p>When the result required by the current instruction is computed during EX stage of the previous instruction( or previous previous instruction), forwarding is used. See the two pairs of hazard conditions:</p>

<ol>
<li>EX/MEM.RegisterRd = ID/EX.RegisterRs</li>
<li>EX/MEM.RegisterRd = ID/EX.RegisterRt</li>
<li>MEM/WB.RegisterRd = ID/EX.RegisterRs</li>
<li>MEM/WB.RegisterRd = ID/EX.RegisterRt</li>
</ol>

<p>The <strong>fowarding unit</strong> is used to forward new values from EX/MEM and MEM/WB pipeline-register to ID/EX pipeline-register when the conditions above occured.</p>

<blockquote>
<p>Note that the values in EX/MEM is newer than MEM/WB, we will forward MEM/WB only when EX/MEM needn&#39;t to be forwarded.</p>
</blockquote>

<h3>Stalls</h3>

<p>When the result required by the current instruction is computed during MEM stage of the previous instruction, we must stall the pipeline.</p>

<p>The <strong>hazard detection unit</strong> operates during the ID stage, checking for load instructions and insert the stall between the load and its use. The single condition is:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">if( ID/EX.MemRead and 
    ((ID/EX.RegisterRt = IF/ID.RegisterRs) or
     (ID/EX.RegisterRt = IF/ID.RegisterRt)))
        stall the pipeline
</code></pre></div>
<p>By identifying the hazard in the ID stage, we can insert a bubble into the pipeline by changing the EX, MEM and WB control fields of the ID/EX pipeline registeer to 0.</p>

<blockquote>
<p>Actually, only the signals RegWrite and MemWrite need be 0, while the other control signals can be don&#39;t cares.</p>
</blockquote>

<p><img src="/assets/img/blog/pipe-control.png" alt="pipe-control"></p>

    
      <style>
  /* JiaThis & Uyan bootstrap fix */
	.jiathis_style *, .jiathis_style,
  .jiathis_style_24x24 *, .jiathis_style_24x24{
      -webkit-box-sizing: content-box!important;
      -moz-box-sizing: content-box!important;
      box-sizing: content-box!important;
  }
  .jiathis_style_24x24{
          margin-top: 20px;
  }
</style>


<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_24x24 pull-right">
	<a class="jiathis_button_fb"></a>
	<a class="jiathis_button_linkedin"></a>
	<a class="jiathis_button_googleplus"></a>
	<!--a class="jiathis_button_tsina"></a-->
	<a class="jiathis_button_weixin"></a>
	<!--a href="http://www.jiathis.com/share?uid=1851884" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a-->
	<!--a class="jiathis_counter_style"></a-->
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1372495112151668" charset="utf-8"></script>
<!-- JiaThis Button END -->


<div class="clearfix"></div>
<hr/>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'harttleland'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
</div>


  </div>

</div>

      </div>
      
    </div>

    <div id="footer">
      <div class="container">
	<div class="credit nowrap">
	  <p class="text-muted" title="Copyright © 2013 Harttle. Hosted by GitHub and powered by Jekyll.">
	    Copyright © 2013 
	    <a href="//harttle.github.io">Harttle</a>. Hosted by
	    <a href="//github.com/" target="_blank">GitHub</a>
	    and powered by
	    <a href="//jekyllrb.com/">Jekyll</a>.
	    
	  </p>
	  <div class="pull-right hidden-xs follow">
	    <a href="https://www.facebook.com/harttle" target="_blank">
	      <i class="fa fa-facebook-square fa-lg"></i>
	    </a>
	    <a href="http://www.linkedin.com/profile/view?id=294339963" target="_blank">
	      <i class="fa fa-linkedin-square fa-lg"></i>
	    </a>
	    <a href="https://plus.google.com/113657098095399233141?rel=author" target="_blank">
	      <i class="fa fa-google-plus-square fa-lg"></i>
	    </a>
	  </div>	  
	</div>
      </div>
    </div>
<!-- content -->

<!-- script -->
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/libs/html5shiv/3.6.2/html5shiv.js"></script>
      <script src="//v3.bootcss.com/docs-assets/js/respond.min.js"></script>
    <![endif]-->
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="/assets/jquery/jquery.scrollUp.min.js"></script>
    <script src="/assets/jquery/jquery.lazyload.min.js" type="text/javascript"></script>
    
    <!-- Bootstrap -->
    <script src="/assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
    
    
    


<script>
  $(function(){    
    var toc = getTOC($('.post-display .right'));
    if (toc != null) {
      $('.sidebar').append(toc);
      
      //sidebar affix, this offset is for sidebar position recognition
      setTimeout(function () {
          var $sideBar = $('.sidebar')
          $sideBar.affix({
              offset: {                
                  top: function () {                    
                      var offsetTop      = $sideBar.offset().top;
                      var sideBarMargin  = parseInt($sideBar.children(0).css('margin-top'), 10);
                      sideBarMargin     += parseInt($('#page-content').css('margin-top'), 10);
                      return (this.top = offsetTop - navHeight - sideBarMargin);
                  },
                  bottom: function(){
                    var sideBarMargin  = parseInt($sideBar.children(0).css('margin-bottom'), 10);
                    return (this.bottom = footHeight + sideBarMargin);
                  }
              }
          });
      },100);
      
      //sidebar scroll spy
      $('body').scrollspy({
        target: '.sidebar',
        offset: navHeight + 10  //make sure to spy the element when scrolled to
      }); 
    }
    else{
      $('.post-display .right').removeClass('col-md-9');
      $('.post-display').removeClass('row-fluid');
      $('.post-display .left').remove();
    }
  });
  
  //生成目录
  function getTOC($content) {    
    var $toc = $('<ul class="nav level-0" >').addClass("nav sidenav");

    var base_level = 1;
    while ($content.find('h' + base_level).length < 1 && base_level < 7) base_level += 1;
    if (base_level == 7) return null;
    
    $content.find(':header').each(function (i) {
      var $this = $(this);
      $this.attr('id', i);
      
      var level = parseInt(this.nodeName.substr(1));
      var offset = level - base_level;
      
      var li = new $('<li/>')
          .append('<a href="#' + i + '" class="animate">' + $this.text() + '</a>')
          .append($('<ul class="nav level-'+(offset+1)+'"/>'));
      
      $('<div>').append($toc).find('ul.level-'+offset+':last').append(li);
    });
    return $toc;
  }
</script>

<!-- latex render begin -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
  MathJax.Hub.Queue(function () {
    $('body').scrollspy('refresh');
  });
</script>
<!--script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG"></script-->
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<!-- latex render end -->



    
    <script>
      var navHeight = 50;
      var footHeight = $('#footer').outerHeight(true);
      $(function(){
	
        //更新菜单
        $('.nav #blog').attr('class','active');
        
        //激活工具提示
        $('[data-toggle="tooltip"]').tooltip();
        
        //图片延迟加载
        $("img.lazy").lazyload({effect : "fadeIn", skip_invisible : false});	//bootstrap thumbnail img will be invisible at the begining
        
        //回到顶部按钮
        $.scrollUp({
	  scrollName: 'scrollUp',topDistance: '300',topSpeed: 300,animation: 'fade',animationInSpeed: 500,
	  animationOutSpeed: 500,scrollText: '',activeOverlay: false,
	});	
        
        //页面内链接滑动效果
        $body = (window.opera) ? (document.compatMode == "CSS1Compat" ? $('html') : $('body')) : $('html,body');
        $('a.animate').click(function(){
          var offset = navHeight;
          if ($(this).attr('offset')) {
            offset += parseInt($(this).attr('offset')); 
          }
          $body.animate({scrollTop: $($(this).attr('href')).offset().top - offset}, 500);
          return false;
        });        
      });
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-45491170-1', 'harttle.github.io');
      ga('send', 'pageview');
    </script>
<!-- script -->

  </body>
</html>
